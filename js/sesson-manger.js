/**
 * ูุธุงู ุฅุฏุงุฑุฉ ุงูุฌูุณุงุช ูุงูุชููุฆุฉ ุงูุชููุงุฆูุฉ
 * โ ุฅุฏุงุฑุฉ ุฌูุณุงุช ุงููุณุชุฎุฏููู
 * โ ุชุชุจุน ุงููุดุงุทุงุช ูุงูุฃูุงู
 * โ ุญูุธ ุงูุฅุญุตุงุฆูุงุช ูุงูุชูุงุฑูุฑ
 */

class SessionManager {
    constructor() {
        this.SESSION_KEYS = {
            CURRENT_USER: 'currentUser',
            THEME: 'appTheme',
            LANGUAGE: 'appLanguage',
            USER_ACTIVITIES: 'userActivities',
            APP_STATISTICS: 'appStatistics',
            ONLINE_USERS: 'onlineUsers',
            PAYMENT_METHODS: 'paymentMethods'
        };
        this.currentUser = null;
        this.init();
    }

    // ุชููุฆุฉ ุงููุธุงู
    init() {
        console.log('โ ูุธุงู ุฅุฏุงุฑุฉ ุงูุฌูุณุงุช ุฌุงูุฒ');
        this.loadSessions();
    }

    // ุญูุธ ุฌูุณุฉ ุงููุณุชุฎุฏู
    saveUserSession(user) {
        try {
            const sessionData = {
                id: user.id,
                email: user.email,
                name: user.name,
                role: user.role,
                phone: user.phone,
                specialty: user.specialty,
                loginTime: new Date().toISOString(),
                lastActivity: new Date().toISOString(),
                sessionId: this.generateSessionId()
            };
            
            localStorage.setItem(this.SESSION_KEYS.CURRENT_USER, JSON.stringify(sessionData));
            this.addToOnlineUsers(user.id);
            console.log('โ ุชู ุญูุธ ุฌูุณุฉ ุงููุณุชุฎุฏู ุจูุฌุงุญ:', user.name);
            return true;
        } catch (error) {
            console.error('โ ุฎุทุฃ ูู ุญูุธ ุงูุฌูุณุฉ:', error);
            return false;
        }
    }

    // ุงุณุชุฑุฌุงุน ุฌูุณุฉ ุงููุณุชุฎุฏู
    loadUserSession() {
        try {
            const savedUser = localStorage.getItem(this.SESSION_KEYS.CURRENT_USER);
            if (savedUser) {
                const userData = JSON.parse(savedUser);
                
                // ุงูุชุญูู ูู ุงูุชูุงุก ุงูุตูุงุญูุฉ (24 ุณุงุนุฉ)
                const loginTime = new Date(userData.loginTime);
                const now = new Date();
                const hoursDiff = (now - loginTime) / (1000 * 60 * 60);
                
                if (hoursDiff > 24) {
                    this.clearUserSession();
                    console.log('๐ ุงูุชูุช ุตูุงุญูุฉ ุงูุฌูุณุฉ');
                    return null;
                }
                
                // ุชุญุฏูุซ ุขุฎุฑ ูุดุงุท
                userData.lastActivity = new Date().toISOString();
                localStorage.setItem(this.SESSION_KEYS.CURRENT_USER, JSON.stringify(userData));
                
                console.log('โ ุชู ุชุญููู ุฌูุณุฉ ุงููุณุชุฎุฏู:', userData.name);
                return userData;
            }
        } catch (error) {
            console.error('โ ุฎุทุฃ ูู ุชุญููู ุงูุฌูุณุฉ:', error);
        }
        return null;
    }

    // ูุณุญ ุฌูุณุฉ ุงููุณุชุฎุฏู
    clearUserSession() {
        try {
            const currentUser = this.loadUserSession();
            if (currentUser) {
                this.removeFromOnlineUsers(currentUser.id);
                this.logUserActivity(currentUser.id, 'logout', 'ุชุณุฌูู ุฎุฑูุฌ');
            }
            
            localStorage.removeItem(this.SESSION_KEYS.CURRENT_USER);
            console.log('โ ุชู ูุณุญ ุฌูุณุฉ ุงููุณุชุฎุฏู ุจูุฌุงุญ');
            return true;
        } catch (error) {
            console.error('โ ุฎุทุฃ ูู ูุณุญ ุงูุฌูุณุฉ:', error);
            return false;
        }
    }

    // ุฅูุดุงุก ูุนุฑู ุฌูุณุฉ ูุฑูุฏ
    generateSessionId() {
        return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // ุฅุถุงูุฉ ูุณุชุฎุฏู ุฅูู ูุงุฆูุฉ ุงููุชุตููู
    addToOnlineUsers(userId) {
        try {
            const onlineUsers = JSON.parse(localStorage.getItem(this.SESSION_KEYS.ONLINE_USERS) || '[]');
            if (!onlineUsers.includes(userId)) {
                onlineUsers.push(userId);
                localStorage.setItem(this.SESSION_KEYS.ONLINE_USERS, JSON.stringify(onlineUsers));
            }
        } catch (error) {
            console.error('ุฎุทุฃ ูู ุฅุถุงูุฉ ูุณุชุฎุฏู ูููุชุตููู:', error);
        }
    }

    // ุฅุฒุงูุฉ ูุณุชุฎุฏู ูู ูุงุฆูุฉ ุงููุชุตููู
    removeFromOnlineUsers(userId) {
        try {
            const onlineUsers = JSON.parse(localStorage.getItem(this.SESSION_KEYS.ONLINE_USERS) || '[]');
            const updatedUsers = onlineUsers.filter(id => id !== userId);
            localStorage.setItem(this.SESSION_KEYS.ONLINE_USERS, JSON.stringify(updatedUsers));
        } catch (error) {
            console.error('ุฎุทุฃ ูู ุฅุฒุงูุฉ ูุณุชุฎุฏู ูู ุงููุชุตููู:', error);
        }
    }

    // ุงูุชุญูู ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูุชุตู
    isUserOnline(userId) {
        try {
            const onlineUsers = JSON.parse(localStorage.getItem(this.SESSION_KEYS.ONLINE_USERS) || '[]');
            return onlineUsers.includes(userId);
        } catch (error) {
            console.error('ุฎุทุฃ ูู ุงูุชุญูู ูู ุญุงูุฉ ุงูุงุชุตุงู:', error);
            return false;
        }
    }

    // ุชุณุฌูู ูุดุงุท ุงููุณุชุฎุฏู
    logUserActivity(userId, action, description) {
        try {
            const activity = {
                userId: userId,
                action: action,
                description: description,
                timestamp: new Date().toISOString(),
                ip: '127.0.0.1',
                userAgent: navigator.userAgent
            };
            
            const activities = JSON.parse(localStorage.getItem(this.SESSION_KEYS.USER_ACTIVITIES) || '[]');
            activities.push(activity);
            
            // ุญูุธ ุขุฎุฑ 500 ูุดุงุท ููุท
            const recentActivities = activities.slice(-500);
            localStorage.setItem(this.SESSION_KEYS.USER_ACTIVITIES, JSON.stringify(recentActivities));
            
            console.log('๐ ุชู ุชุณุฌูู ุงููุดุงุท:', description);
        } catch (error) {
            console.error('โ ุฎุทุฃ ูู ุชุณุฌูู ุงููุดุงุท:', error);
        }
    }

    // ุงูุญุตูู ุนูู ูุดุงุท ุงููุณุชุฎุฏู
    getUserActivities(userId, limit = 50) {
        try {
            const activities = JSON.parse(localStorage.getItem(this.SESSION_KEYS.USER_ACTIVITIES) || '[]');
            const userActivities = activities.filter(activity => activity.userId === userId);
            return userActivities.slice(-limit).reverse();
        } catch (error) {
            console.error('โ ุฎุทุฃ ูู ุฌูุจ ูุดุงุท ุงููุณุชุฎุฏู:', error);
            return [];
        }
    }

    // ุงูุญุตูู ุนูู ุฌููุน ุงููุดุงุทุงุช
    getAllActivities(limit = 100) {
        try {
            const activities = JSON.parse(localStorage.getItem(this.SESSION_KEYS.USER_ACTIVITIES) || '[]');
            return activities.slice(-limit).reverse();
        } catch (error) {
            console.error('โ ุฎุทุฃ ูู ุฌูุจ ุงููุดุงุทุงุช:', error);
            return [];
        }
    }

    // ุญูุธ ุฅุญุตุงุฆูุงุช ุงูุชุทุจูู
    saveAppStatistics(stats) {
        try {
            localStorage.setItem(this.SESSION_KEYS.APP_STATISTICS, JSON.stringify({
                ...stats,
                lastUpdate: new Date().toISOString()
            }));
            return true;
        } catch (error) {
            console.error('โ ุฎุทุฃ ูู ุญูุธ ุงูุฅุญุตุงุฆูุงุช:', error);
            return false;
        }
    }

    // ุชุญููู ุฅุญุตุงุฆูุงุช ุงูุชุทุจูู
    loadAppStatistics() {
        try {
            const stats = localStorage.getItem(this.SESSION_KEYS.APP_STATISTICS);
            return stats ? JSON.parse(stats) : {
                totalUsers: 0,
                totalDoctors: 0,
                totalPatients: 0,
                totalAppointments: 0,
                monthlyRevenue: 0,
                activeUsers: 0
            };
        } catch (error) {
            console.error('โ ุฎุทุฃ ูู ุชุญููู ุงูุฅุญุตุงุฆูุงุช:', error);
            return null;
        }
    }

    // ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงูุฌูุณุงุช
    updateSessionStats() {
        const stats = this.loadAppStatistics();
        
        stats.totalSessions = (stats.totalSessions || 0) + 1;
        stats.activeSessions = JSON.parse(localStorage.getItem(this.SESSION_KEYS.ONLINE_USERS) || '[]').length;
        stats.lastUpdate = new Date().toISOString();
        
        this.saveAppStatistics(stats);
        return stats;
    }

    // ุงูุชุญูู ูู ุตุญุฉ ุงูุฌูุณุฉ
    validateSession() {
        const savedUser = this.loadUserSession();
        if (!savedUser) return false;

        // ุงูุชุญูู ูู ุฃู ุงููุณุชุฎุฏู ูุง ูุฒุงู ููุฌูุฏุงู ูู ุงููุธุงู
        const currentUsers = window.users || [];
        const userExists = currentUsers.find(u => u.id === savedUser.id && u.email === savedUser.email);
        
        if (!userExists) {
            this.clearUserSession();
            return false;
        }
        
        return true;
    }

    // ุงูุญุตูู ุนูู ูุนูููุงุช ุงูุฌูุณุฉ ุงูุญุงููุฉ
    getSessionInfo() {
        const session = this.loadUserSession();
        if (!session) return null;

        const loginTime = new Date(session.loginTime);
        const now = new Date();
        const sessionDuration = Math.floor((now - loginTime) / (1000 * 60));

        return {
            user: session,
            sessionId: session.sessionId,
            duration: sessionDuration,
            isExpired: sessionDuration > 1440
        };
    }

    // ุฅุฏุงุฑุฉ ุทุฑู ุงูุฏูุน
    getPaymentMethods() {
        try {
            const methods = localStorage.getItem(this.SESSION_KEYS.PAYMENT_METHODS);
            return methods ? JSON.parse(methods) : [
                { id: 1, name: 'ุงูุฏูุน ููุฏุงู', enabled: true, description: 'ุงูุฏูุน ุงููุจุงุดุฑ ูู ุงูุนูุงุฏุฉ' },
                { id: 2, name: 'ุจุทุงูุฉ ุงุฆุชูุงู', enabled: true, description: 'ุงูุฏูุน ุจุจุทุงูุงุช ุงูุงุฆุชูุงู' },
                { id: 3, name: 'ุชุญููู ุจููู', enabled: true, description: 'ุงูุชุญููู ุงูุจููู ุงููุจุงุดุฑ' },
                { id: 4, name: 'ูุญูุธุฉ ุฅููุชุฑูููุฉ', enabled: false, description: 'ุงูุฏูุน ุนุจุฑ ุงููุญุงูุธ ุงูุฅููุชุฑูููุฉ' }
            ];
        } catch (error) {
            console.error('โ ุฎุทุฃ ูู ุชุญููู ุทุฑู ุงูุฏูุน:', error);
            return [];
        }
    }

    savePaymentMethods(methods) {
        try {
            localStorage.setItem(this.SESSION_KEYS.PAYMENT_METHODS, JSON.stringify(methods));
            console.log('โ ุชู ุญูุธ ุทุฑู ุงูุฏูุน ุจูุฌุงุญ');
            return true;
        } catch (error) {
            console.error('โ ุฎุทุฃ ูู ุญูุธ ุทุฑู ุงูุฏูุน:', error);
            return false;
        }
    }

    // ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงููุณุชุฎุฏููู
    updateUserStatistics() {
        const users = window.users || [];
        const stats = this.loadAppStatistics();
        
        stats.totalUsers = users.length;
        stats.totalDoctors = users.filter(u => u.role === 'doctor').length;
        stats.totalPatients = users.filter(u => u.role === 'patient').length;
        stats.totalAppointments = window.appData?.appointments?.length || 0;
        stats.monthlyRevenue = this.calculateMonthlyRevenue();
        stats.activeUsers = JSON.parse(localStorage.getItem(this.SESSION_KEYS.ONLINE_USERS) || '[]').length;
        
        this.saveAppStatistics(stats);
        return stats;
    }

    // ุญุณุงุจ ุงูุฅูุฑุงุฏุงุช ุงูุดูุฑูุฉ
    calculateMonthlyRevenue() {
        const transactions = window.appData?.transactions || [];
        const currentMonth = new Date().toISOString().substr(0, 7); // YYYY-MM
        
        return transactions
            .filter(t => t.date && t.date.startsWith(currentMonth) && t.type === 'ุฏุฎู' && t.status === 'ููุชูู')
            .reduce((sum, t) => sum + (t.amount || 0), 0);
    }

    // ุฅููุงุก ุฌููุน ุงูุฌูุณุงุช
    terminateAllSessions() {
        try {
            localStorage.removeItem(this.SESSION_KEYS.CURRENT_USER);
            localStorage.removeItem(this.SESSION_KEYS.ONLINE_USERS);
            console.log('โ ุชู ุฅููุงุก ุฌููุน ุงูุฌูุณุงุช');
            return true;
        } catch (error) {
            console.error('โ ุฎุทุฃ ูู ุฅููุงุก ุงูุฌูุณุงุช:', error);
            return false;
        }
    }

    // ุชุญููู ุงูุฌูุณุงุช
    loadSessions() {
        try {
            const sessions = {
                currentUser: this.loadUserSession(),
                paymentMethods: this.getPaymentMethods(),
                statistics: this.loadAppStatistics(),
                onlineUsers: JSON.parse(localStorage.getItem(this.SESSION_KEYS.ONLINE_USERS) || '[]')
            };
            
            console.log('๐ ุญุงูุฉ ุงููุธุงู:', {
                usersOnline: sessions.onlineUsers.length,
                currentUser: sessions.currentUser?.name,
                paymentMethods: sessions.paymentMethods.length
            });
            
            return sessions;
        } catch (error) {
            console.error('โ ุฎุทุฃ ูู ุชุญููู ุงูุฌูุณุงุช:', error);
            return {};
        }
    }
}

// ุฅูุดุงุก instance ูู ูุฏูุฑ ุงูุฌูุณุงุช
const sessionManager = new SessionManager();

// ุฏุงูุงุช ุนุงูุฉ ูููุตูู ูู ุงููููุงุช ุงูุฃุฎุฑู
function saveUserSession(user) {
    return sessionManager.saveUserSession(user);
}

function loadUserSession() {
    return sessionManager.loadUserSession();
}

function clearUserSession() {
    return sessionManager.clearUserSession();
}

function validateUserSession() {
    return sessionManager.validateSession();
}

function logUserActivity(userId, action, description) {
    return sessionManager.logUserActivity(userId, action, description);
}

function getUserActivities(userId, limit = 50) {
    return sessionManager.getUserActivities(userId, limit);
}

function getAllActivities(limit = 100) {
    return sessionManager.getAllActivities(limit);
}

function isUserOnline(userId) {
    return sessionManager.isUserOnline(userId);
}

function getPaymentMethods() {
    return sessionManager.getPaymentMethods();
}

function savePaymentMethods(methods) {
    return sessionManager.savePaymentMethods(methods);
}

function updateUserStatistics() {
    return sessionManager.updateUserStatistics();
}

// ุฌุนู ุงููุฏูุฑ ูุชุงุญุงู globally
window.sessionManager = sessionManager;

console.log('โ ูุธุงู ุฅุฏุงุฑุฉ ุงูุฌูุณุงุช ุชู ุชุญูููู ุจูุฌุงุญ');
